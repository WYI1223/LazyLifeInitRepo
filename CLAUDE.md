# CLAUDE.md

> AI agent guidance for the **LazyNote** repository.
> Strictly reflects the current codebase. Do not infer features that are not yet implemented.

---

## Project Snapshot

**LazyNote** is a local-first personal productivity app (Windows-first MVP).
Stack: **Flutter UI → Flutter-Rust Bridge (FRB) FFI → Rust Core → SQLite**.

Current status: **v0.1 in development.** Notes + tags are functional. Tasks / calendar / sync are planned but not yet implemented.

---

## Package Responsibilities

### `crates/lazynote_core` — All Business Logic

The single source of truth for domain rules, data models, persistence, and search.

**Boundary rule:** Rust Core owns invariants, validation, persistence, indexing, and sync mappings. Flutter may contain interaction parsing (e.g., command syntax) and display-derived state (e.g., UI-only sort order) — these are *interaction logic*, not domain invariants.

| Module | Path | Responsibility |
|--------|------|----------------|
| `model` | `src/model/atom.rs` | Canonical `Atom` entity; `AtomType`, `TaskStatus` enums; validation invariants |
| `db` | `src/db/` | SQLite connection bootstrap, migration executor (`PRAGMA user_version`-tracked) |
| `repo` | `src/repo/atom_repo.rs` | `AtomRepository` trait + `SqliteAtomRepository` CRUD impl |
| `repo` | `src/repo/note_repo.rs` | Note-specific CRUD, tag normalization, `NoteRecord` DTO |
| `service` | `src/service/atom_service.rs` | `AtomService<R>` — high-level atom creation façade |
| `service` | `src/service/note_service.rs` | `NoteService` — note create/update/list, markdown preview derivation |
| `search` | `src/search/fts.rs` | FTS5 `search_all(query, conn)` returning `Vec<SearchHit>` |
| `logging` | `src/logging.rs` | `flexi_logger` rolling-file logger; call `init_logging()` once at startup |

### `crates/lazynote_ffi` — FFI Boundary Only

Exposes Rust functions to Dart via Flutter-Rust Bridge. Contains **no business logic**.

| File | Rule |
|------|------|
| `src/api.rs` | **Edit here** to add/change exported FFI functions |
| `src/frb_generated.rs` | **Do not edit.** Auto-generated by FRB codegen. Regenerate via `scripts/gen_bindings.ps1` |

### `crates/lazynote_cli` — Debug/Import/Export (Stub)

Currently a skeleton. Planned for CLI data inspection and migration tools. No business logic duplication.

### `apps/lazynote_flutter` — UI Only

Flutter app. All data operations go through FFI calls. No state is stored outside of `lib/core/` provider infrastructure.

| Path | Responsibility |
|------|----------------|
| `lib/app/` | Routes (`AppRoutes`) + root `MaterialApp` shell |
| `lib/core/rust_bridge.dart` | `RustBridge` façade: FFI init, logging bootstrap, DB path config |
| `lib/core/bindings/` | **Auto-generated** Dart FFI wrappers — do not edit |
| `lib/core/local_paths.dart` | Platform-specific `%APPDATA%/LazyLife/` resolution |
| `lib/core/settings/` | `LocalSettingsStore` — persists log level, DB path |
| `lib/features/entry/` | Single-entry search/command panel + `CommandParser` + `CommandRouter` |
| `lib/features/notes/` | Note list, tab manager, editor, tag filter UI |
| `lib/features/tags/` | `TagFilter` widget |
| `lib/features/search/` | Search results view |
| `lib/features/diagnostics/` | Rust health panel + live log viewer |

---

## Build & Test Commands

### Rust (run from `crates/`)

```bash
cargo fmt --all -- --check          # format check
cargo clippy --all -- -D warnings   # lint (warnings are errors)
cargo test --all                    # all tests
cargo test -p lazynote_core         # single crate
cargo test -p lazynote_core -- <test_name>  # single test
```

### Flutter (run from `apps/lazynote_flutter/`)

```bash
flutter pub get
dart format --output=none --set-exit-if-changed .   # format check
flutter analyze                                      # lint
flutter test                                         # unit + widget tests
flutter build windows --debug                        # Windows build
```

### Dev Scripts (PowerShell, from repo root)

| Script | Purpose |
|--------|---------|
| `scripts/doctor.ps1` | Verify Rust + Flutter + Windows SDK toolchain |
| `scripts/gen_bindings.ps1` | Regenerate FRB Dart + Rust bindings after editing `api.rs` |
| `scripts/format.ps1` | Format all code (Rust + Dart) |

---

## Architecture Rules (Mandatory — from `docs/architecture/engineering-standards.md`)

These are the v0.1 baseline constraints. **Changing any Rule A–F requires an ADR** (Architecture Decision Record) filed in `docs/architecture/decisions/`.

These are hard constraints enforced across the codebase:

| Rule | Constraint |
|------|-----------|
| **A** | Invariants, validation, persistence, indexing, sync → `crates/lazynote_core`. Flutter may contain interaction parsing and display-derived state; it must not contain domain invariants or persistence logic. |
| **B** | `crates/lazynote_ffi` exposes use-case APIs (e.g., `create_note`, `search`), **never** raw DB operations. Exception: `debug_*` / `experimental_*` prefixed functions may expose lower-level hooks for diagnostics only; they carry no stability guarantee. |
| **C** | All entities use stable UUIDs (never reused). **Business-path deletion is soft-delete only** (`is_deleted` flag). Maintenance tools (vacuum, retention purge) may hard-delete with an ADR documenting the rationale. |
| **D** | External sync mappings (e.g., Google Calendar) live in Core, never in Flutter. |
| **E** | Flutter `features/<name>` modules must **not** import each other's internals. Cross-feature UI primitives go to `lib/shared/`; cross-feature domain operations go through Core API. |
| **F** | Default runtime root: `%APPDATA%/LazyLife/` (Windows), `<app_support>/LazyLife/` (other platforms). The root and DB path may be overridden via `settings.json` or `configure_entry_db_path()`; all path resolution is coordinated by Core. |

---

## Data Model

**Canonical entity: `Atom`** (`crates/lazynote_core/src/model/atom.rs`)

```rust
pub struct Atom {
    pub uuid: AtomId,                        // UUIDv4, stable, never reused
    pub kind: AtomType,                      // Note | Task | Event — rendering hint only
    pub content: String,                     // Markdown body
    pub preview_text: Option<String>,        // Derived from content (first non-empty text)
    pub preview_image: Option<String>,       // First markdown image path
    pub task_status: Option<TaskStatus>,     // Todo | InProgress | Done | Cancelled; NULL = no status
    pub start_at: Option<i64>,              // Epoch ms (added in Migration 6)
    pub end_at: Option<i64>,                // Epoch ms; end_at >= start_at when both set (Migration 6)
    pub recurrence_rule: Option<String>,    // Reserved: RFC 5545 RRULE string; NULL until v0.2+
    pub hlc_timestamp: Option<String>,       // Reserved for CRDT (not yet used)
    pub is_deleted: bool,                    // Authoritative soft-delete flag
}
```

**Atom Time-Matrix** — list section is derived from `start_at`/`end_at` nullability, NOT from `kind`:

| start_at | end_at | Semantic | Section |
|----------|--------|----------|---------|
| NULL | NULL | Pure note / idea | Inbox |
| NULL | Value | DDL task (deadline = end_at) | Today if overdue/today, else Upcoming |
| Value | NULL | Ongoing task (started = start_at) | Today if started, else Upcoming |
| Value | Value | Timed event / time block | Today if overlaps today, else Upcoming |

`kind` determines rendering shape (checkbox / text / time bar). `task_status IN ('done','cancelled')` hides the atom from all sections.

**Invariants** (enforced by `Atom::validate()`):
- `uuid` is never nil
- `end_at >= start_at` when both are set
- All default queries filter `WHERE is_deleted = 0`

Full section SQL is in `docs/architecture/data-model.md`.

---

## Database Schema

5 migrations tracked via `PRAGMA user_version` in `crates/lazynote_core/src/db/migrations/`.

| Version | File | Table(s) Added |
|---------|------|----------------|
| 1 | `0001_init.sql` | `atoms` (UUID, type, content, timestamps, soft-delete) |
| 2 | `0002_tags.sql` | `tags` (id, name), `atom_tags` junction |
| 3 | `0003_external_mappings.sql` | `external_mappings` (provider, external_id, atom_uuid) |
| 4 | `0004_fts.sql` | `atoms_fts` FTS5 virtual table + sync triggers |
| 5 | `0005_note_preview.sql` | `preview_text`, `preview_image` columns on `atoms` |
| 6 | `0006_time_matrix.sql` | Rename `event_start`→`start_at`, `event_end`→`end_at`; add `recurrence_rule TEXT` (reserved) |

**Never** modify existing migrations after they are applied to any user database. Add a new numbered SQL file for schema changes. (Pre-v1.0 squash is allowed with documented process — see Adding a Database Migration.)

---

## FFI API Surface

All functions are defined in `crates/lazynote_ffi/src/api.rs`.

### Response Envelopes

```rust
// Used by single-item operations
pub struct EntryActionResponse {
    pub ok: bool,
    pub atom_id: Option<String>,
    pub message: String,
}

// Used by list operations
pub struct EntryListResponse {
    pub ok: bool,
    pub error_code: Option<String>,
    pub items: Vec<EntryListItem>,       // Each: { atom_id, content, preview_text, tags, updated_at }
    pub message: String,
    pub total_count: Option<u32>,
}

// Used by search
pub struct EntrySearchResponse {
    pub ok: bool,
    pub error_code: Option<String>,
    pub items: Vec<EntrySearchItem>,    // Each: { atom_id, kind, snippet, rank }
    pub message: String,
    pub applied_limit: u32,
}
```

**Error codes** (from `docs/api/error-codes.md`):
`invalid_note_id`, `invalid_tag`, `note_not_found`, `db_error`, `invalid_argument`, `internal_error`

> **Stability note:** In v0.x, error codes and FFI contracts may change with documented rationale in the PR. Stability guarantees begin at v1.0.

### Exported Functions

**Bootstrap (synchronous, safe to call on UI thread):**

| Function | Returns | Notes |
|----------|---------|-------|
| `ping()` | `String` | Returns `"pong"` |
| `core_version()` | `String` | Version string |
| `init_logging(level, log_dir)` | `String` | Empty string = success; error message on failure |
| `configure_entry_db_path(db_path)` | `String` | Empty string = success |

**Entry (async):**

| Function | Returns |
|----------|---------|
| `entry_search(text, limit?)` | `EntrySearchResponse` |
| `entry_create_note(content)` | `EntryActionResponse` |
| `entry_create_task(content)` | `EntryActionResponse` | **(stub — Tasks not yet implemented)** |
| `entry_schedule(title, start, end?)` | `EntryActionResponse` | **(stub — Calendar not yet implemented)** |

**Notes & Tags (async):**

| Function | Returns |
|----------|---------|
| `note_create(content)` | `EntryActionResponse` |
| `note_update(atom_id, content)` | `EntryActionResponse` |
| `note_get(atom_id)` | `EntryActionResponse` |
| `notes_list(tag?, limit?, offset?)` | `EntryListResponse` |
| `note_set_tags(atom_id, tags[])` | `EntryActionResponse` |
| `tags_list()` | `EntryListResponse` |

**Pagination defaults:** `limit = 10`, `max = 50`.
**Tag normalization:** Tags are lowercased and deduplicated. Single-tag filter only in v0.1.

---

## Adding a New FFI Function (Workflow)

1. Add the function to `crates/lazynote_ffi/src/api.rs` with `#[flutter_rust_bridge::frb(sync)]` or async annotation.
2. Add any new types as public structs in the same file.
3. Run `scripts/gen_bindings.ps1` to regenerate `frb_generated.rs` and the Dart bindings under `lib/core/bindings/`.
4. Add a Rust doc comment (`///`) to the function.
5. Add core logic to `crates/lazynote_core` if needed (service or repo layer), never in `lazynote_ffi`.
6. Update `docs/api/ffi-contracts.md` and `docs/governance/API_COMPATIBILITY.md`.
7. Write tests in `crates/lazynote_core/src/` (unit) and optionally Flutter widget tests.

---

## Adding a Database Migration

1. Create `crates/lazynote_core/src/db/migrations/000N_description.sql` (next sequential number).
2. Register it in `crates/lazynote_core/src/db/migrations/mod.rs` in the `MIGRATIONS` constant array.
3. **Never modify existing migration files** after they have been applied to any user database — only add new ones. Exception: before v1.0 release, squashing migrations (merging into a new baseline) is allowed with a documented process and explicit team sign-off; after v1.0, this rule is absolute.
4. Update `docs/architecture/data-model.md` to reflect schema changes.

---

## Runtime File Layout

```
%APPDATA%\LazyLife\        (Windows)
<app_support>/LazyLife/    (macOS / iOS)

  settings.json            — App settings (log level, DB path, etc.)
  logs/                    — Rolling log files from flexi_logger
  data/
    lazynote.db            — SQLite main database
```

All path resolution is in `apps/lazynote_flutter/lib/core/local_paths.dart`.

---

## Commit & PR Conventions

- **Conventional Commits required**: `feat(scope):`, `fix(scope):`, `chore(scope):`, `docs(scope):`, `test(scope):`, `refactor(scope):`
- **One concern per PR**; never mix a feature with unrelated refactoring.
- All public Rust functions must have `///` doc comments.
- `TODO` / `FIXME` must be traceable: `TODO(#123)`, `TODO(v0.2)`, `FIXME(perf)`.
- Comment standards: `docs/architecture/code-comment-standards.md`.
- API contract changes require updating `docs/api/*` and `docs/governance/API_COMPATIBILITY.md`.

---

## Key Documentation Map

| Document | Path | Contents |
|----------|------|----------|
| Architecture rules | `docs/architecture/engineering-standards.md` | 6 mandatory rules |
| Data model spec | `docs/architecture/data-model.md` | Atom invariants, schema tables |
| FFI contract | `docs/api/ffi-contract-v0.1.md` | All exported function specs |
| FFI contracts (notes/tags) | `docs/api/ffi-contracts.md` | Consolidated notes/tags API |
| Error codes | `docs/api/error-codes.md` | Stable error code registry |
| API compatibility | `docs/governance/API_COMPATIBILITY.md` | What counts as breaking |
| v0.1 release plan | `docs/releases/v0.1/README.md` | PR roadmap & current status |
| Windows quickstart | `docs/development/windows-quickstart.md` | Minimal dev setup |
| Logging design | `docs/architecture/logging.md` | Structured log schema |
| Settings config | `docs/architecture/settings-config.md` | App root, settings lifecycle |

---

## Common Pitfalls for AI Agents

- **Never edit `frb_generated.rs`** — it is always overwritten by codegen.
- **Never edit `lib/core/bindings/api.dart`** — also auto-generated.
- **Do not add business logic to `lazynote_ffi`** — only thin FFI wrappers belong there.
- **Do not add domain invariants or persistence logic to Flutter** — validation rules and all storage go in `lazynote_core`. Interaction parsing and display-derived state in Flutter are acceptable (see Rule A boundary definition).
- **Soft delete in business paths** — never issue `DELETE FROM atoms` in feature code. Set `is_deleted = 1`. Hard-delete is only permitted in maintenance/purge tooling, with an ADR.
- **Atom fields are currently public** — this is a known tech debt (v0.2 will privatize them). Do not rely on direct field mutation as a stable pattern.
- **FRB bindings must be regenerated** after any change to `api.rs`. Do not skip `gen_bindings.ps1`.
- **Tags are lowercased** by the repo layer; pass normalized lowercase tags from the service layer too.
- **`notes_list` sort order**: `updated_at DESC, uuid ASC` — do not change this without updating the contract doc.
- **Single-entry input parsing** lives in `lib/features/entry/command_parser.dart` (Flutter), not in Rust Core. This is intentional for v0.1 UX iteration speed.
- **`event_start`/`event_end` are renamed** to `start_at`/`end_at` in Migration 6 (v0.1.5). Do not reference the old column names in new code.
- **Section classification uses time fields, not `AtomType`**. `kind`/`type` is a rendering hint only. See `docs/architecture/data-model.md` for section SQL.
