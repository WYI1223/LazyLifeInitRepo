# FFI Contracts

This file is the consolidated index for FFI contracts.

## Sources

- Rust API: `crates/lazynote_ffi/src/api.rs`
- Dart generated API: `apps/lazynote_flutter/lib/core/bindings/api.dart`

## v0.1 Contract Sets

1. Single Entry contracts:
   - `docs/api/ffi-contract-v0.1.md`
   - `docs/api/single-entry-contract.md`
2. Notes/tags contracts (PR-0010B):
   - this document section below

## Entry API Notes (PR-0219)

- `entry_search(text, limit?)`
  - default limit: `10`
  - max limit: `50` (`ENTRY_SEARCH_MAX_LIMIT`)
  - stable error codes on failure:
    - `db_error` for DB open/bootstrap failures
    - `internal_error` for search execution failures

## Notes/Tags APIs (PR-0010B)

All APIs are use-case level and async.

- `note_create(content)`
- `note_update(atom_id, content)` (full replace)
- `note_get(atom_id)`
- `notes_list(tag?, limit?, offset?)`
- `note_set_tags(atom_id, tags[])` (atomic full replace)
- `tags_list()`

### Response Shape Rules

- Never require UI to parse free-text messages for branching.
- Failure branch must carry stable `error_code`.
- `message` is for diagnostics/display only.

### Notes Payload

- `atom_id`
- `content`
- `preview_text`
- `preview_image`
- `updated_at`
- `tags`

### Pagination

- default limit: `10`
- max limit: `50`
- ordering: `updated_at DESC, uuid ASC`

### Tag Semantics

- normalized lowercase storage
- case-insensitive match
- v0.1 filter is single-tag equality (`tag = X`)

## Error Code Mapping (Notes/Tags)

Producer: `crates/lazynote_ffi/src/api.rs`

- `invalid_note_id`
- `invalid_tag`
- `note_not_found`
- `db_busy`
- `db_error`
- `invalid_argument`
- `internal_error`

See full registry: `docs/api/error-codes.md`.

---

## Workspace Tree APIs (PR-0203 + PR-0221)

All APIs are use-case level and async.

### API Set

- `workspace_list_children(parent_node_id?) -> WorkspaceListChildrenResponse`
  - `parent_node_id = null` lists root-level nodes.
- `workspace_create_folder(parent_node_id?, name) -> WorkspaceNodeResponse`
- `workspace_create_note_ref(parent_node_id?, atom_id, display_name?) -> WorkspaceNodeResponse`
- `workspace_rename_node(node_id, new_name) -> WorkspaceActionResponse`
- `workspace_move_node(node_id, new_parent_id?, target_order?) -> WorkspaceActionResponse`
- `workspace_delete_folder(node_id, mode) -> WorkspaceActionResponse`
  - `mode`: `dissolve` | `delete_all`

### Workspace Node Payload

`WorkspaceNodeItem`:

- `node_id`
- `kind` (`folder|note_ref`)
- `parent_node_id`
- `atom_id`
- `display_name`
- `sort_order`

Envelope rules:

- all workspace responses keep deterministic `ok/error_code/message`
- `WorkspaceNodeResponse` carries optional `node`
- `WorkspaceListChildrenResponse` carries `items`

### Error Code Mapping (Workspace Tree)

Producer: `crates/lazynote_ffi/src/api.rs`

- `invalid_node_id`
- `invalid_parent_node_id`
- `invalid_atom_id`
- `invalid_display_name`
- `invalid_delete_mode`
- `node_not_found`
- `parent_not_found`
- `node_not_folder`
- `parent_not_folder`
- `atom_not_found`
- `atom_not_note`
- `cycle_detected`
- `db_busy`
- `db_error`
- `internal_error`

Detailed contract: `docs/api/workspace-tree-contract.md`.

### Controller-Local Error Codes (Workspace Tree UI)

Producer: `apps/lazynote_flutter/lib/features/notes/notes_controller.dart`

These codes are generated by Flutter controller guard paths and are not emitted
from Rust FFI:

- `busy` - reject overlapping folder-delete action while one is already in flight
- `save_blocked` - reject folder delete when pre-delete draft flush fails

See full registry: `docs/api/error-codes.md`.

---

## Tasks/Status APIs (PR-0011A, v0.1.5)

All APIs are use-case level and async.

### New Response Types

**`AtomListItem`** — full atom projection for section queries:

- `atom_id: String` — stable UUID
- `kind: String` — `"note"` | `"task"` | `"event"` (rendering hint)
- `content: String` — markdown body
- `preview_text: String?` — derived plain-text summary
- `preview_image: String?` — derived first image path
- `tags: Vec<String>` — normalized lowercase tags
- `start_at: i64?` — epoch ms
- `end_at: i64?` — epoch ms
- `task_status: String?` — `"todo"` | `"in_progress"` | `"done"` | `"cancelled"` | null
- `updated_at: i64` — epoch ms

**`AtomListResponse`** — envelope for section list queries:

- `ok: bool` — execution success flag
- `error_code: String?` — stable machine-readable error code
- `items: Vec<AtomListItem>` — result list
- `message: String` — human-readable status text
- `total_count: u32?` — total matching records (before pagination)

**Migration note**: `notes_list` and `tags_list` will migrate from `NoteItem`/`NotesListResponse`
to `AtomListItem`/`AtomListResponse` in v0.2 when list views are unified. Both type families
coexist until then.

### Section Queries

- `tasks_list_inbox() -> AtomListResponse`
  - Returns atoms with `start_at IS NULL AND end_at IS NULL` and active status
  - Order: `updated_at DESC, uuid ASC`

- `tasks_list_today(bod_ms: i64, eod_ms: i64) -> AtomListResponse`
  - `bod_ms`: beginning of today (00:00:00 local, epoch ms)
  - `eod_ms`: end of today (23:59:59 local, epoch ms)
  - Returns atoms active today per time-matrix logic
  - Order: `COALESCE(start_at, end_at) ASC, updated_at DESC`

- `tasks_list_upcoming(eod_ms: i64) -> AtomListResponse`
  - `eod_ms`: end of today (lower bound for future atoms)
  - Returns atoms entirely in the future
  - Order: `COALESCE(start_at, end_at) ASC, updated_at DESC`

Time parameters are computed by Flutter (device-local timezone). Rust Core does not
compute device-local time.

### Status Update

- `atom_update_status(atom_id: String, status: Option<String>) -> EntryActionResponse`
  - `status`: `"todo"` | `"in_progress"` | `"done"` | `"cancelled"` | `null`
  - `null` clears `task_status` (demote to statusless atom)
  - Idempotent: setting the same status twice is not an error
  - Applies to any atom type (universal completion — see PR-0011 §D1)

### Response Shape Rules

Same rules as Notes/Tags:
- Never require UI to parse free-text messages for branching.
- Failure branch must carry stable `error_code`.
- `message` is for diagnostics/display only.

### Error Code Mapping (Tasks/Status)

Producer: `crates/lazynote_ffi/src/api.rs`

- `invalid_atom_id` — atom_id format invalid (non-UUID)
- `atom_not_found` — target atom missing or soft-deleted
- `invalid_status` — status string not in allowed set
- `db_error` — repository/database failure
- `internal_error` — unexpected invariant failure

See full registry: `docs/api/error-codes.md`.

---

## Calendar APIs (PR-0012A)

All APIs are use-case level and async.

### Range Query

- `calendar_list_by_range(start_ms: i64, end_ms: i64, limit?: u32, offset?: u32) -> AtomListResponse`
  - Returns atoms with both `start_at` and `end_at` set that overlap the given time range
  - Overlap condition: `start_at < end_ms AND end_at > start_ms`
  - Includes all statuses (done/cancelled shown on calendar)
  - Order: `start_at ASC, end_at ASC`
  - Reuses `AtomListResponse` / `AtomListItem` types from tasks APIs
  - Default limit: `50`, max: `50`

### Event Time Update

- `calendar_update_event(atom_id: String, start_ms: i64, end_ms: i64) -> EntryActionResponse`
  - Updates only `start_at` and `end_at` for a calendar event
  - Validates `end_ms >= start_ms`; returns `invalid_time_range` error code on failure
  - Returns `atom_not_found` when target atom does not exist or is soft-deleted
  - Does not modify content, tags, or task_status — time adjustment is an independent operation

### Error Code Mapping (Calendar)

Producer: `crates/lazynote_ffi/src/api.rs`

- `invalid_time_range` — end_at < start_at in event time update
- `invalid_atom_id` — atom_id format invalid (non-UUID)
- `atom_not_found` — target atom missing or soft-deleted
- `db_error` — repository/database failure

See full registry: `docs/api/error-codes.md`.
